#!/bin/bash

# 11: Service unavailable
# 12: Cannot get DebugInfo
# 1: No InputContext focusing

if ! dbus-send --session --dest=org.fcitx.Fcitx5 --type=method_call --print-reply /controller org.freedesktop.DBus.Peer.Ping 2>&1 | grep -q "method return"; then
    exit 11
fi

DEBUG_INFO=$(timeout 1s dbus-send --session --print-reply --dest=org.fcitx.Fcitx5 /controller org.fcitx.Fcitx.Controller1.DebugInfo 2>&1)

if ! echo "$DEBUG_INFO" | grep -q "string.*"; then
    exit 12
fi

if echo "$DEBUG_INFO" | grep -q "focus:1"; then
    dbus-send --session --type=method_call --dest=org.fcitx.Fcitx5 /controller org.fcitx.Fcitx.Controller1.Toggle > /dev/null 2>&1
    dbus-send --session --type=method_call --dest=org.fcitx.Fcitx5 /controller org.fcitx.Fcitx.Controller1.Refresh > /dev/null 2>&1
    # echo "$(date %H:%M:%S) Triggered" > ~/.fcitx_switch.log
else
    exit 1
fi
